
<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="A JavaScript Computer Vision Library">
<meta name="author" content="Eugene Zatepyakin">
<title>JSFeat - JavaScript Computer Vision Library.</title>

</head>
<body>
<label for="r1">r1: </label><input type="range" id="r1" style="width: 700px" min="0" max="1" step="0.01" oninput="updateR12()"><br>
<label for="r2">r2: </label><input type="range" id="r2" style="width: 700px" min="0" max="1" step="0.01" oninput="updateR12()">
<br>
<video id="webcam" width="640" height="480"></video>
<canvas id="canvas" width="640" height="480"></canvas>
<canvas id="savnac" width="640" height="480"></canvas>


<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script type="text/javascript" src="jsfeat.js"></script>
<script type="text/javascript" src="compat.js"></script>
<script type="text/javascript" src="color.js"></script>
<script type="text/javascript">
// lets do some fun
var video = document.getElementById('webcam');
var canvas = document.getElementById('canvas');
var savnac = document.getElementById('savnac');

// var alpha = 50, 
//     lambda_c = 4, 
//     r1 = 0.4, 
//     r2 = 0.05, 
//     chromAttenuation = 1;


var alpha = 10, 
    lambda_c = 16, 
    r1 = 0.4, 
    r2 = 0.05, 
    chromAttenuation = 1;

document.getElementById('r1').value = r1;
document.getElementById('r2').value = r2;


// var frames = [];
// for(var i = 0; i < 301; i++){
//     frames[i] = new Image()
//     frames[i].src = 'face/' + ('000' + (i + 1)).slice(-3) + '.png'
// }


function updateR12(){
    r1 = +document.getElementById('r1').value;
    r2 = +document.getElementById('r2').value;    
}

try {
    var attempts = 0;
    var readyListener = function(event) {
        findVideoSize();
    };
    var findVideoSize = function() {
        if(video.videoWidth > 0 && video.videoHeight > 0) {
            video.removeEventListener('loadeddata', readyListener);
            onDimensionsReady(video.videoWidth, video.videoHeight);
        } else {
            if(attempts < 10) {
                attempts++;
                setTimeout(findVideoSize, 200);
            } else {
                onDimensionsReady(640, 480);
            }
        }
    };
    var onDimensionsReady = function(width, height) {
        // demo_app(width, height);
        compatibility.requestAnimationFrame(tick);
    };

    video.addEventListener('loadeddata', readyListener);

    compatibility.getUserMedia({video: true}, function(stream) {
        try {
            video.src = compatibility.URL.createObjectURL(stream);
        } catch (error) {
            video.src = stream;
        }
        setTimeout(function() {
            video.play();
        }, 500);
    }, function (error) {
        video.src = 'face.mp4'
        video.loop = 'loop'
        video.autoplay = 'autoplay'
        console.log('walp')

    });
} catch (error) {
    $('#canvas').hide();
    $('#log').hide();
    $('#no_rtc').html('<h4>Something goes wrong...</h4>');
    $('#no_rtc').show();
}

var current_frame = 0;
// function doit(){
//     ctx.drawImage(frames[current_frame], 0, 0)
//     evm()
//     current_frame++
//     if(current_frame >= frames.length) current_frame = 0;
//     requestAnimationFrame(doit);
// }

function tick() {
    compatibility.requestAnimationFrame(tick);
    // stat.new_frame();
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        // ctx.drawImage(video, 0, 0, 640, 480);
        ctx.fillRect(0, 0, 640, 480)
        var s = Math.min(640 / video.videoWidth, 480 / video.videoHeight)
        // var s = 0.01 // call this number for fun times
        ctx.drawImage(video, 0, 0, video.videoWidth * s, video.videoHeight * s)

        evm()
    }
}

demo_app(640, 480)

onclick = function(){
    lowpass1.iirFilter(img_pyr, 1);
    lowpass2.iirFilter(img_pyr, 1);
}
</script>
</body>
</html>